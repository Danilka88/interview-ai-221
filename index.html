<!DOCTYPE html>
<html lang="ru" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Голосовое собеседование</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>
        body {
            padding-top: 5rem;
        }

        main.container {
            margin-top: 1rem;
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        #chat-log {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            padding: 1rem;
            border-radius: var(--pico-border-radius);
            max-width: 85%;
            width: fit-content;
        }

        .message p {
            margin: 0;
            line-height: 1.5;
        }

        .message strong {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--pico-h6-color);
        }

        .interviewer {
            align-self: flex-start;
            background-color: var(--pico-secondary-background);
        }

        .user {
            align-self: flex-end;
            background-color: var(--pico-primary);
            color: var(--pico-primary-inverse);
        }

        .user strong {
            color: var(--pico-primary-inverse);
            opacity: 0.8;
        }

        footer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
            border-top: 1px solid var(--pico-card-border);
        }

        #status-container {
            text-align: center;
            min-height: 40px;
            padding: 0.5rem;
            color: var(--pico-muted-color);
        }

        #talkButton {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: none;
            background-color: #43a047;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #talkButton:disabled {
            background-color: var(--pico-muted-background);
            cursor: not-allowed;
        }

        #talkButton.recording {
            background-color: #d32f2f;
            transform: scale(1.1);
            box-shadow: 0 0 0 10px rgba(211, 47, 47, 0.4);
        }

        #upload-container form>* {
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <nav class="container-fluid">
        <ul>
            <li>
                <details class="dropdown">
                    <summary role="button">Меню</summary>
                    <ul>
                        <!-- Группа 1: Основной воркфлоу -->
                        <li><a href="/dashboard">Дашборд</a></li>
                        <li><a href="/rank">Отбор резюме</a></li>
                        <li><hr></li>
                        <!-- Группа 2: Отдельные инструменты -->
                        <li><a href="/vacancy_builder">Конструктор вакансий</a></li>
                        <li><a href="/voice-interview">Голосовое собеседование</a></li>
                        <li><a href="/test">Текстовая симуляция</a></li>
                        <li><hr></li>
                        <!-- Группа 3: Настройки и прочее -->
                        <li><a href="/settings">Настройки</a></li>
                        <li><a href="/audio-processing/settings">Настройки обработки аудио</a></li>
                        <li><a href="/llm-providers/settings">Настройки LLM-провайдеров</a></li>
                        <li><a href="/result">Последний отчет</a></li>
                        <li><a href="#" id="clear-storage-btn">Очистить кэш</a></li>
                    </ul>
                </details>
            </li>
        </ul>
        <ul>
            <li><strong>VTB AI</strong></li>
        </ul>
    </nav>

    <main class="container">
        <!-- Экран 1: Загрузка файлов -->
        <div id="upload-container">
            <header>
                <hgroup>
                    <h2>Голосовое собеседование</h2>
                    <p>Загрузите файлы для персонализации диалога</p>
                </hgroup>
            </header>
            <form id="upload-form">
                <label for="vacancy-file">1. Описание вакансии (опционально)
                    <input type="file" id="vacancy-file" name="vacancy">
                </label>
                <label for="resume-file">2. Резюме кандидата (опционально)
                    <input type="file" id="resume-file" name="resume">
                </label>
                <button type="submit" id="upload-button" aria-busy="false">Начать</button>
            </form>
            <small id="upload-status"></small>
        </div>

        <!-- Экран 2: Голосовой чат -->
        <div id="interview-container" style="display: none; flex-direction: column; height: 100%;">
            <header>
                <hgroup>
                    <h2 id="interview-title" style="text-align: center; margin-bottom: 0;">Идет собеседование...</h2>
                    <p style="text-align: center; margin: 0;">ИИ-рекрутер задает вопросы голосом, а вы отвечаете,
                        удерживая кнопку.</p>
                </hgroup>
            </header>
            <section id="chat-log"></section>
            <div id="status-container">
                <small id="status">Подготовка к диалогу...</small>
                <small id="user-partial-text"></small>
            </div>
            <footer>
                <button id="talkButton" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                    </svg>
                </button>
                <button id="finishInterviewButton" class="secondary">Завершить</button>
            </footer>
        </div>
    </main>

    <script>
        // DOM Elements
        const uploadContainer = document.getElementById('upload-container');
        const interviewContainer = document.getElementById('interview-container');
        const uploadForm = document.getElementById('upload-form');
        const uploadButton = document.getElementById('upload-button');
        const uploadStatus = document.getElementById('upload-status');
        const vacancyFile = document.getElementById('vacancy-file');
        const resumeFile = document.getElementById('resume-file');
        const interviewTitle = document.getElementById('interview-title');
        const talkButton = document.getElementById('talkButton');
        const finishInterviewButton = document.getElementById('finishInterviewButton');
        const statusDiv = document.getElementById('status');
        const chatLog = document.getElementById('chat-log');
        const userPartialTextSpan = document.getElementById('user-partial-text');

        // State
        let ws;
        let isRecording = false;
        let audioContext;
        let scriptProcessor;
        let stream;
        let conversationHistory = [];
        let interviewContext = {};

        function switchToInterviewView() {
            uploadContainer.style.display = 'none';
            interviewContainer.style.display = 'flex';
            connect();
        }

        async function uploadAndProcessFile(file, endpoint) {
            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch(endpoint, { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Ошибка при загрузке ${file.name}: ${response.statusText}`);
            return await response.json();
        }

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadButton.setAttribute('aria-busy', 'true');
            uploadButton.disabled = true;

            try {
                if (vacancyFile.files.length > 0) {
                    uploadStatus.innerHTML = 'Шаг 1/2: Анализ вакансии и генерация вопросов...';
                    const result = await uploadAndProcessFile(vacancyFile.files[0], '/upload-vacancy');
                    interviewContext.vacancy_text = result.vacancy_text;
                    interviewContext.generated_questions = result.generated_questions;
                }
                if (resumeFile.files.length > 0) {
                    uploadStatus.innerHTML = 'Шаг 2/2: Анализ резюме...';
                    const result = await uploadAndProcessFile(resumeFile.files[0], '/upload-resume');
                    interviewContext.resume_text = result.resume_text;
                }

                uploadStatus.innerHTML = '<b>Все готово!</b><br><small>Перехожу к диалогу...</small>';
                setTimeout(switchToInterviewView, 1000);

            } catch (error) {
                alert(`Не удалось загрузить файлы: ${error.message}`);
                uploadButton.setAttribute('aria-busy', 'false');
                uploadButton.disabled = false;
                uploadStatus.textContent = 'Ошибка загрузки.';
            }
        });

        function addMessage(sender, text) {
            const senderMap = {
                'Interviewer': 'AI Рекрутер',
                'User': 'Вы (кандидат)',
                'Candidate': 'AI Кандидат'
            };
            const localizedSender = senderMap[sender] || sender;

            const article = document.createElement('article');
            const senderClass = sender.toLowerCase() === 'user' || sender.toLowerCase() === 'candidate' ? 'user' : 'interviewer';
            article.className = `message ${senderClass}`;
            article.innerHTML = `<strong>${localizedSender}</strong><p>${text}</p>`;
            chatLog.appendChild(article);
            chatLog.scrollTop = chatLog.scrollHeight;
            conversationHistory.push({ sender, text }); // Важно: сохраняем оригинальный ключ
        }

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/live`);

            ws.onopen = () => {
                statusDiv.textContent = 'Соединение установлено. Отправка контекста...';
                const selectedLanguage = localStorage.getItem('selectedLanguage') || 'ru'; // Получаем язык
                const startMessage = {
                    type: 'start_interview',
                    ...interviewContext,
                    language: selectedLanguage // Добавляем язык в сообщение
                };
                ws.send(JSON.stringify(startMessage));
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'text') {
                    addMessage(message.sender, message.data);
                    userPartialTextSpan.textContent = '';
                } else if (message.type === 'partial_text') {
                    userPartialTextSpan.textContent = message.data;
                } else if (message.type === 'status') {
                    statusDiv.textContent = message.data;
                } else if (message.type === 'audio') {
                    userPartialTextSpan.textContent = '';
                    if (message.data) {
                        statusDiv.textContent = 'ИИ говорит...';
                        talkButton.disabled = true;
                        const audio = new Audio("data:audio/wav;base64," + message.data);
                        audio.play();
                        audio.onended = () => {
                            talkButton.disabled = false;
                            statusDiv.textContent = 'Ваш ход. Удерживайте кнопку для ответа.';
                        };
                    } else {
                        talkButton.disabled = false;
                        statusDiv.textContent = 'Не удалось распознать ответ. Попробуйте снова.';
                    }
                } else if (message.type === 'error') {
                    statusDiv.textContent = `Ошибка сервера: ${message.message}`;
                    talkButton.style.display = 'none';
                    finishInterviewButton.style.display = 'none';
                }
            };

            ws.onerror = (error) => { statusDiv.textContent = 'Ошибка WebSocket соединения.'; console.error('WebSocket Error:', error); };
            ws.onclose = () => { statusDiv.textContent = 'Соединение закрыто.'; talkButton.disabled = true; finishInterviewButton.disabled = true; };
        }

        async function toggleRecording(start) {
            if (start) {
                if (ws.readyState !== WebSocket.OPEN) { statusDiv.textContent = 'Нет соединения с сервером.'; return; }
                isRecording = true;
                talkButton.classList.add('recording');
                statusDiv.textContent = 'Запись...';
                try {
                    if (!audioContext || audioContext.state === 'closed') {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                    }
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    const source = audioContext.createMediaStreamSource(stream);
                    scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
                    scriptProcessor.onaudioprocess = (e) => {
                        if (!isRecording || ws.readyState !== WebSocket.OPEN) return;
                        const inputData = e.inputBuffer.getChannelData(0);
                        const pcmData = new Int16Array(inputData.length);
                        for (let i = 0; i < inputData.length; i++) { pcmData[i] = inputData[i] * 0x7FFF; }
                        ws.send(pcmData.buffer);
                    };
                    source.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);
                } catch (err) {
                    statusDiv.textContent = `Ошибка микрофона: ${err.message}`;
                    console.error(err);
                    toggleRecording(false);
                }
            } else {
                if (!isRecording) return;
                isRecording = false;
                talkButton.classList.remove('recording');
                talkButton.disabled = true;
                statusDiv.textContent = 'Обработка ответа...';
                if (scriptProcessor) { scriptProcessor.disconnect(); scriptProcessor = null; }
                if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
                if (ws.readyState === WebSocket.OPEN) { ws.send(new ArrayBuffer(0)); }
            }
        }

        finishInterviewButton.addEventListener('click', () => {
            if (ws) ws.close();
            const dataToAnalyze = { ...interviewContext, conversation_history: conversationHistory };
            localStorage.setItem('interviewAnalysisData', JSON.stringify(dataToAnalyze));
            window.location.href = '/result';
        });

        talkButton.addEventListener('mousedown', () => toggleRecording(true));
        talkButton.addEventListener('mouseup', () => toggleRecording(false));
        talkButton.addEventListener('mouseleave', () => { if (isRecording) toggleRecording(false); });
        talkButton.addEventListener('touchstart', (e) => { e.preventDefault(); toggleRecording(true); }, { passive: false });
        talkButton.addEventListener('touchend', (e) => { e.preventDefault(); toggleRecording(false); });

        document.getElementById('clear-storage-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Вы уверены, что хотите очистить все загруженные данные (вакансию и резюме)?')) {
                localStorage.removeItem('interviewAnalysisData');
                alert('Кэш очищен. Страница будет перезагружена.');
                window.location.href = '/';
            }
        });

    </script>
</body>

</html>