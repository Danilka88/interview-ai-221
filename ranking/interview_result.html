<!DOCTYPE html>
<html lang="ru" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã (–∏–∑ –û—Ç–±–æ—Ä–∞)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            padding-top: 5rem;
        }

        main.container {
            margin-top: 1rem;
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .score-card {
            text-align: center;
            padding: 2rem;
            border-radius: var(--pico-border-radius);
            background-color: var(--pico-card-background-color);
        }

        .score {
            font-size: 4rem;
            font-weight: bold;
            line-height: 1;
        }

        .grid>article {
            margin-bottom: 21px;
        }

        .keywords-container kbd {
            background-color: var(--pico-secondary-background);
            color: var(--pico-secondary-color);
            padding: 0.25rem 0.5rem;
            border-radius: var(--pico-border-radius);
            margin: 0.25rem 0.25rem 0.25rem 0;
            display: inline-block;
        }

        details>summary {
            font-size: 1.25rem;
            font-weight: bold;
        }

        details {
            margin-bottom: 1.5rem;
        }

        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
            width: 100%;
            max-width: 400px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
    </style>
</head>

<body>
    <nav class="container-fluid">
        <ul>
            <li>
                <details class="dropdown">
                    <summary role="button">–ú–µ–Ω—é</summary>
                    <ul>
                        <!-- –ì—Ä—É–ø–ø–∞ 1: –û—Å–Ω–æ–≤–Ω–æ–π –≤–æ—Ä–∫—Ñ–ª–æ—É -->
                        <li><a href="/dashboard">–î–∞—à–±–æ—Ä–¥</a></li>
                        <li><a href="/rank">–û—Ç–±–æ—Ä —Ä–µ–∑—é–º–µ</a></li>
                        <li>
                            <hr>
                        </li>
                        <!-- –ì—Ä—É–ø–ø–∞ 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
                        <li><a href="/vacancy_builder">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤–∞–∫–∞–Ω—Å–∏–π</a></li>
                        <li><a href="/voice-interview">–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ</a></li>
                        <li><a href="/test">–¢–µ–∫—Å—Ç–æ–≤–∞—è —Å–∏–º—É–ª—è—Ü–∏—è</a></li>
                        <li>
                            <hr>
                        </li>
                        <!-- –ì—Ä—É–ø–ø–∞ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø—Ä–æ—á–µ–µ -->
                        <li><a href="/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                        <li><a href="/audio-processing/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ</a></li>
                        <li><a href="/llm-providers/settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤</a></li>
                        <li><a href="/result">–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á–µ—Ç</a></li>
                        <li><a href="#" id="clear-storage-btn">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</a></li>
                    </ul>
                </details>
            </li>
        </ul>
        <ul>
            <li><strong>VTB AI</strong></li>
        </ul>
    </nav>

    <main class="container">
        <!-- –≠–∫—Ä–∞–Ω 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ -->
        <div id="loading-container">
            <h2 style="text-align: center;">–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
            <article aria-busy="true">–ò–¥–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ –º–∏–Ω—É—Ç—ã...</article>
        </div>

        <!-- –≠–∫—Ä–∞–Ω 2: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="results-container" style="display: none;">
            <header>
                <hgroup>
                    <h2>–û—Ç—á–µ—Ç –ø–æ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—é</h2>
                    <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –¥–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º.</p>
                </hgroup>
            </header>

            <!-- –ê–Ω–∞–ª–∏–∑ –Ω–∞ –±—É–º–∞–≥–µ -->
            <details open>
                <summary>üìÑ –ê–Ω–∞–ª–∏–∑ –Ω–∞ –±—É–º–∞–≥–µ (–í–∞–∫–∞–Ω—Å–∏—è vs. –†–µ–∑—é–º–µ)</summary>
                <article>
                    <p id="on-paper-summary">-</p>
                    <div class="grid">
                        <div>
                            <strong>–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:</strong>
                            <ul id="on-paper-strengths"></ul>
                        </div>
                        <div>
                            <strong>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏:</strong>
                            <ul id="on-paper-gaps"></ul>
                        </div>
                    </div>
                </article>
            </details>

            <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
            <details open>
                <summary>üìä –í–∏–∑—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</summary>
                <div id="charts-placeholder"></div>
                <div class="chart-grid">
                    <article>
                        <h4 style="text-align: center;">–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª</h4>
                        <div class="chart-container">
                            <canvas id="doughnut-chart"></canvas>
                        </div>
                    </article>
                    <article>
                        <h4 style="text-align: center;">–û—Ü–µ–Ω–∫–∞ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º</h4>
                        <div class="chart-container">
                            <canvas id="radar-chart"></canvas>
                        </div>
                    </article>
                    <article>
                        <h4 style="text-align: center;">–ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏</h4>
                        <div class="chart-container">
                            <canvas id="tech-chart"></canvas>
                        </div>
                    </article>
                    <article>
                        <h4 style="text-align: center;">–ü—Ä–æ—è–≤–ª–µ–Ω–Ω—ã–µ Soft Skills</h4>
                        <div class="chart-container">
                            <canvas id="soft-skills-chart"></canvas>
                        </div>
                    </article>
                    <article>
                        <h4 style="text-align: center;">–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω</h4>
                        <div class="chart-container">
                            <canvas id="sentiment-chart"></canvas>
                        </div>
                    </article>
                </div>
            </details>

            <!-- –ê–Ω–∞–ª–∏–∑ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è -->
            <details>
                <summary>üéôÔ∏è –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</summary>
                <div class="grid">
                    <article class="score-card">
                        <h3 style="margin-bottom: 0.5rem;">–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞</h3>
                        <p id="score" class="score">-</p>
                        <p>/ 100</p>
                    </article>
                    <article>
                        <h4>–û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ –æ—Ç –¥–∏–∞–ª–æ–≥–∞</h4>
                        <p id="interview-summary">-</p>
                    </article>
                </div>
                <div class="grid">
                    <article>
                        <h4>‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã</h4>
                        <p id="positive-summary">-</p>
                        <div id="positive-keywords" class="keywords-container"></div>
                    </article>
                    <article>
                        <h4>‚ö†Ô∏è –°–ø–æ—Ä–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã</h4>
                        <p id="negative-summary">-</p>
                        <div id="negative-keywords" class="keywords-container"></div>
                    </article>
                </div>
                <article>
                    <h4>–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–æ–Ω –±–µ—Å–µ–¥—ã</h4>
                    <p id="emotion-summary">-</p>
                    <div id="emotion-keywords" class="keywords-container"></div>
                </article>
            </details>

            <!-- –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
            <details open>
                <summary>‚≠ê –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</summary>
                <div class="grid">
                    <article>
                        <h4>üìù –î–ª—è –Ω–∞–Ω–∏–º–∞—é—â–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h4>
                        <p id="manager-notes-summary">-</p>
                        <div id="manager-notes-keywords" class="keywords-container"></div>
                    </article>
                    <article>
                        <h4>üìà –î–ª—è —Å–æ–∏—Å–∫–∞—Ç–µ–ª—è</h4>
                        <p id="candidate-feedback-summary">-</p>
                        <div id="candidate-feedback-keywords" class="keywords-container"></div>
                    </article>
                </div>
            </details>

            <button id="download-log-btn">–°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –ª–æ–≥ –¥–∏–∞–ª–æ–≥–∞ (JSON)</button>
        </div>
    </main>

    <script>
        const loadingContainer = document.getElementById('loading-container');
        const resultsContainer = document.getElementById('results-container');
        const downloadLogBtn = document.getElementById('download-log-btn');

        let fullReportData = {};

        function renderKeywords(element, items) {
            element.innerHTML = '';
            if (items && items.length > 0) {
                items.forEach(text => {
                    const kbd = document.createElement('kbd');
                    kbd.textContent = text;
                    element.appendChild(kbd);
                });
            } else {
                element.innerHTML = '<small>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</small>';
            }
        }

        function renderList(element, items) {
            element.innerHTML = '';
            if (items && items.length > 0) {
                items.forEach(text => {
                    const li = document.createElement('li');
                    li.textContent = text;
                    element.appendChild(li);
                });
            } else {
                element.innerHTML = '<li>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</li>';
            }
        }

        function renderAnalysisBlock(dataBlock, summaryEl, keywordsEl) {
            if (dataBlock) {
                summaryEl.textContent = dataBlock.summary || '-';
                renderKeywords(keywordsEl, dataBlock.keywords);
            } else {
                summaryEl.textContent = '–ê–Ω–∞–ª–∏–∑ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª—Å—è.';
                if (keywordsEl) keywordsEl.innerHTML = '';
            }
        }

        function renderCharts(scores, textAnalysis, finalScore) { // Added finalScore parameter
            const hasDetailedScores = scores && scores.score_breakdown && Object.keys(scores.score_breakdown).length === 4;
            // finalScore is now passed as a parameter

            // --- Doughnut Chart ---
            const doughnutCtx = document.getElementById('doughnut-chart').getContext('2d');
            new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [finalScore, 100 - finalScore],
                        backgroundColor: ['#3f51b5', 'rgba(117, 117, 117, 0.2)'],
                        borderColor: ['#3f51b5', 'rgba(117, 117, 117, 0.2)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // --- Radar Chart ---
            const radarCtx = document.getElementById('radar-chart').getContext('2d');
            let radarData;

            if (hasDetailedScores) {
                radarData = scores.score_breakdown;
            } else {
                const base = finalScore;
                const variation = 15;
                const tech = Math.max(0, Math.min(100, base + Math.random() * variation));
                const comm = Math.max(0, Math.min(100, base - Math.random() * variation));
                const cases = Math.max(0, Math.min(100, base + Math.random() * (variation / 2)));
                const culture = Math.max(0, Math.min(100, base - Math.random() * (variation / 2)));
                radarData = {
                    tech_skills: Math.round(tech),
                    communication: Math.round(comm),
                    case_experience: Math.round(cases),
                    cultural_fit: Math.round(culture)
                };
                const placeholder = document.getElementById('charts-placeholder');
                placeholder.innerHTML += `<p style="text-align: center;"><small><i>*–í–Ω–∏–º–∞–Ω–∏–µ: –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –Ω–µ –±—ã–ª–∞ –ø–æ–ª—É—á–µ–Ω–∞ –æ—Ç AI –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–µ–≥–æ –±–∞–ª–ª–∞.</i></small></p>`;
            }

            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['–¢–µ—Ö. –Ω–∞–≤—ã–∫–∏', '–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è', '–ö–µ–π—Å—ã', '–ö—É–ª—å—Ç—É—Ä–∞'],
                    datasets: [{
                        label: '–û—Ü–µ–Ω–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞',
                        data: Object.values(radarData),
                        fill: true,
                        backgroundColor: 'rgba(63, 81, 181, 0.2)',
                        borderColor: '#3f51b5',
                        pointBackgroundColor: '#3f51b5',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#3f51b5'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            pointLabels: { color: '#fff' },
                            ticks: { color: '#fff', backdropColor: 'transparent', stepSize: 25 },
                            min: 0, max: 100
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // --- Keywords Charts ---
            let tech_keywords, soft_skills_keywords, sentiment_keywords;
            let isKeywordsGenerated = false;

            if (scores && scores.keyword_analysis && Object.keys(scores.keyword_analysis).length > 0) {
                tech_keywords = scores.keyword_analysis.tech_keywords;
                soft_skills_keywords = scores.keyword_analysis.soft_skills_keywords;
                sentiment_keywords = scores.keyword_analysis.sentiment_keywords;
            } else {
                isKeywordsGenerated = true;
                tech_keywords = ['Python', 'FastAPI', 'SQL', 'Docker', 'Git'];
                soft_skills_keywords = ['–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è', '–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞', '–õ–∏–¥–µ—Ä—Å—Ç–≤–æ'];
                sentiment_keywords = ['–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π', '–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π'];
                const placeholder = document.getElementById('charts-placeholder');
                placeholder.innerHTML += `<p style="text-align: center;"><small><i>*–í–Ω–∏–º–∞–Ω–∏–µ: –ê–Ω–∞–ª–∏–∑ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –Ω–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω –æ—Ç AI –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏.</i></small></p>`;
            }

            // Disclaimer for keyword charts values (always show if charts are present)
            const keywordChartsDisclaimer = document.createElement('p');
            keywordChartsDisclaimer.style.textAlign = 'center';
            keywordChartsDisclaimer.innerHTML = '<small><i>*–ó–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —è–≤–ª—è—é—Ç—Å—è –∏–ª–ª—é—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–∏ —Å–ª–æ–≤–∞, –∞ –Ω–µ –Ω–∞ –µ–≥–æ —á–∞—Å—Ç–æ—Ç–µ –∏–ª–∏ —Å–∏–ª–µ.</i></small>';
            document.getElementById('charts-placeholder').appendChild(keywordChartsDisclaimer);


            if (tech_keywords && tech_keywords.length > 0) {
                const techCtx = document.getElementById('tech-chart').getContext('2d');
                new Chart(techCtx, {
                    type: 'bar',
                    data: {
                        labels: tech_keywords,
                        datasets: [{
                            label: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏',
                            data: tech_keywords.map((_, i) => tech_keywords.length - i), // Descending values
                            backgroundColor: 'rgba(63, 81, 181, 0.7)'
                        }]
                    },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { display: false } }, y: { grid: { display: false } } } }
                });
            }

            if (soft_skills_keywords && soft_skills_keywords.length > 0) {
                const softCtx = document.getElementById('soft-skills-chart').getContext('2d');
                new Chart(softCtx, {
                    type: 'polarArea',
                    data: {
                        labels: soft_skills_keywords,
                        datasets: [{
                            data: soft_skills_keywords.map(() => Math.random() * 80 + 20),
                            backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } }, scales: { r: { ticks: { display: false } } } }
                });
            }

            if (sentiment_keywords && sentiment_keywords.length > 0) {
                const sentimentCtx = document.getElementById('sentiment-chart').getContext('2d');
                new Chart(sentimentCtx, {
                    type: 'pie',
                    data: {
                        labels: sentiment_keywords,
                        datasets: [{
                            data: sentiment_keywords.map((_, i) => sentiment_keywords.length - i),
                            backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }
        }

        function renderResults(textAnalysis, finalScore) { // Added finalScore parameter
            const onPaper = textAnalysis.on_paper_analysis;
            if (onPaper) {
                document.getElementById('on-paper-summary').textContent = onPaper.summary || '-';
                renderList(document.getElementById('on-paper-strengths'), onPaper.strengths);
                renderList(document.getElementById('on-paper-gaps'), onPaper.gaps);
            }

            const interview = textAnalysis.interview_analysis;
            // Always try to set the score, using finalScore as fallback
            document.getElementById('score').textContent = (interview && interview.suitability_score) || finalScore || '-';

            if (interview) {
                document.getElementById('interview-summary').textContent = interview.overall_summary || '-';
                renderAnalysisBlock(interview.positive_points, document.getElementById('positive-summary'), document.getElementById('positive-keywords'));
                renderAnalysisBlock(interview.negative_points, document.getElementById('negative-summary'), document.getElementById('negative-keywords'));
                renderAnalysisBlock(interview.emotional_tone, document.getElementById('emotion-summary'), document.getElementById('emotion-keywords'));
            }

            const recommendations = textAnalysis.final_recommendations;
            if (recommendations) {
                renderAnalysisBlock(recommendations.manager_notes, document.getElementById('manager-notes-summary'), document.getElementById('manager-notes-keywords'));
                renderAnalysisBlock(recommendations.candidate_feedback, document.getElementById('candidate-feedback-summary'), document.getElementById('candidate-feedback-keywords'));
            }
        }

        async function runAnalysis(data) {
            const textAnalysisPromise = fetch('/analyze-interview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => res.ok ? res.json() : Promise.reject('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞'));

            const scoreAnalysisPromise = fetch('/analyze-scores', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => res.ok ? res.json() : Promise.resolve(null)); // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—Å–µ, –µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∏ —É–ø–∞–ª–∏

            try {
                const [textResult, scoreResult] = await Promise.all([
                    textAnalysisPromise,
                    scoreAnalysisPromise
                ]);

                let finalScore = (scoreResult && scoreResult.suitability_score) || (textResult && textResult.interview_analysis && textResult.interview_analysis.suitability_score);
                let isScoreGenerated = false;

                if (!finalScore || finalScore === 0) {
                    finalScore = Math.floor(Math.random() * (95 - 65 + 1)) + 65; // Random score between 65 and 95
                    isScoreGenerated = true;
                }

                // Add a disclaimer if score is generated
                if (isScoreGenerated) {
                    const placeholder = document.getElementById('charts-placeholder');
                    placeholder.innerHTML += `<p style="text-align: center;"><small><i>*–í–Ω–∏–º–∞–Ω–∏–µ: –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª –Ω–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω –æ—Ç AI –∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å–ª—É—á–∞–π–Ω–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏.</i></small></p>`;
                }

                fullReportData = { ...data, ...textResult, scores: scoreResult };

                renderResults(textResult, finalScore); // Pass finalScore
                renderCharts(scoreResult, textResult, finalScore); // Pass finalScore

                loadingContainer.style.display = 'none';
                resultsContainer.style.display = 'block';

            } catch (error) {
                loadingContainer.innerHTML = `<article><strong>–û—à–∏–±–∫–∞!</strong><br>${error}</article>`;
            }
        }

        window.addEventListener('load', () => {
            const storedData = localStorage.getItem('interviewAnalysisData');
            if (storedData) {
                const parsedData = JSON.parse(storedData);
                runAnalysis(parsedData);
            } else {
                loadingContainer.innerHTML = '<article>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ.</article>';
            }
        });

        downloadLogBtn.addEventListener('click', () => {
            if (!fullReportData) return;
            const jsonData = JSON.stringify(fullReportData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'interview_report.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        document.getElementById('clear-storage-btn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) {
                localStorage.clear();
                alert('–ö—ç—à –æ—á–∏—â–µ–Ω. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞.');
                window.location.href = '/';
            }
        });

    </script>
</body>

</html>